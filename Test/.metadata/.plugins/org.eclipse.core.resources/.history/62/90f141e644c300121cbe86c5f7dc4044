import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.RandomAccessFile;
import java.net.DatagramPacket;
import java.util.Date;


public class Receiver {

	/**
	 * @param args
	 */
	public static void main(String[] args) {
		FileCombinerPlus fc = new FileCombinerPlus("/Users/Freehan/Desktop/Test/copy28",28L); //43422/28
		SocketManager sm = new SocketManager();
		fc.setSm(sm);
		ReceiverRecoveryListener rrl = new ReceiverRecoveryListener(sm, fc);
		
		while(fc.getNextSeqNum() <= fc.getBlockNum())
		{
			DatagramPacket pack = sm.recievePacket();
			
			if(pack == null){
				
				//Check if File Transmission is Complete
				if(fc.getNextSeqNum() > fc.getBlockNum())
					break;
				
				System.err.println("Socket Failed to Receive a Packet");
				continue;
			}
			else
			{
				int seqN = SocketManager.getPacketSeqNum(pack);
//				System.out.println("Receive data packet:"+ seqN);
				//Receive Data Packet
				if(seqN >= fc.getNextSeqNum() && !fc.isWritten(pack))
				{	
					fc.putDatapacketIntoBuffer(pack);
					fc.restart();
				}
				else if(seqN > 0)
				{
					rrl.hsContainsAndRemove(seqN);
				}
				//Receive Recovery Request Packet And Receiver Had it
				else if(seqN < 0 && fc.isWritten(Math.abs(seqN)))
				{
					Date now = new Date();
					byte[] timestamp = SocketManager.getPacketData(pack);
					long timeElapse = now.getTime() - SocketManager.convertBytesToLong(timestamp);
					
					seqN = Math.abs(seqN);				
					rrl.hsAdd(seqN);
					rrl.startResendTask(seqN, timeElapse);
			
					
				}
				
			}		
		}
		
		System.out.println("Receiver Listener Ended with fc.NextSeqNum:"+fc.getNextSeqNum());
		
		
		
		//!!!!!!!!!!!!!!!!!!!!!Previous Implementation!!!!!!!!!!!!!!!!!!
//		SocketManager Receiver = new SocketManager();
//		
//		
//		try {
//			RandomAccessFile raf = new RandomAccessFile("/Users/Freehan/Desktop/Test/test.wmv", "rw");
//			System.out.println("Start Listening");
//			for(int i=0;i<200;i++){
//				DatagramPacket pack = Receiver.recievePacket();
//				if(pack == null){
//					System.err.println("Socket Failed to Receive a Packet");
//					continue;
//				}
//				System.out.println(Receiver.getPacketSeqNum(pack));
//				System.out.println("Packet Payload Size:"+ pack.getLength());
//				
//				
//				raf.write(pack.getData(), 4, pack.getLength()-4);
//				
//			}
//		
//		} catch (FileNotFoundException e) {
//			// TODO Auto-generated catch block
//			
//			System.err.println("FileNotFoundException");
//			
//			e.printStackTrace();
//		} catch (IOException e) {
//			// TODO Auto-generated catch block
//			System.err.println("Write throws IOException");
//			
//			
//			e.printStackTrace();
//		}
	}

}
